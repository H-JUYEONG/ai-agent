name: Deploy to AWS EC2

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ìë™ ë°°í¬
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±°ë„ ê°€ëŠ¥

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3
      
      # 2. SSH í‚¤ ì„¤ì •
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      
      # 3. .env íŒŒì¼ ìƒì„± (EC2ì—ì„œ)
      - name: Create .env file on EC2
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/ai-agent
            cat > .env << ENVEOF
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }}
          SERPER_API_KEY=${{ secrets.SERPER_API_KEY }}
          LANGSMITH_API_KEY=${{ secrets.LANGSMITH_API_KEY }}
          LANGSMITH_TRACING=true
          LANGSMITH_PROJECT=ai-service-advisor
          REDIS_HOST=redis
          REDIS_PORT=6379
          ENVEOF
          EOF
      
      # 4. EC2ì— ì½”ë“œ ë™ê¸°í™”
      - name: Sync files to EC2
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.env' \
            --exclude 'venv' \
            -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:~/ai-agent/
      
      # 5. deploy.sh ì‹¤í–‰
      - name: Deploy with deploy.sh
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/ai-agent
            chmod +x deploy.sh
            ./deploy.sh
          EOF
      
      # 6. ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      - name: Deployment Summary
        if: success()
        run: |
          echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ URL: http://${{ secrets.EC2_HOST }}:8000"
      
      # 7. ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
      - name: Deployment Failed
        if: failure()
        run: |
          echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."

